name: Build Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Manuel çalıştırma için

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.4'
        channel: 'stable'
        cache: true
    
    - name: Setup Visual Studio Build Tools
      uses: microsoft/setup-msbuild@v1
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Generate app icons
      run: flutter pub run flutter_launcher_icons:main
    
    - name: Build Windows
      run: flutter build windows --release --verbose
    
    - name: Verify Windows Build
      shell: pwsh
      run: |
        $bundlePath = "build/windows/x64/runner/Release"
        
        # Check if main executable exists
        if (-not (Test-Path "$bundlePath/teknetv.exe")) {
          Write-Error "Main executable not found: $bundlePath/teknetv.exe"
          exit 1
        }
        
        # Check if Flutter DLL exists
        if (-not (Test-Path "$bundlePath/flutter_windows.dll")) {
          Write-Error "Flutter DLL not found: $bundlePath/flutter_windows.dll"
          exit 1
        }
        
        # Check if assets exist
        if (-not (Test-Path "$bundlePath/data/flutter_assets")) {
          Write-Error "Flutter assets not found: $bundlePath/data/flutter_assets"
          exit 1
        }
        
        # List all files in build directory
        Write-Host "Build directory contents:"
        Get-ChildItem -Path $bundlePath -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
        
        Write-Host "Windows build verification completed successfully"

    - name: Create portable ZIP (includes all dependencies)
      shell: pwsh
      run: |
        $bundlePath = "build/windows/x64/runner/Release"
        $zipPath = "teknetv-windows-portable.zip"

        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }

        $requiredFiles = @(
          "$bundlePath/teknetv.exe",
          "$bundlePath/flutter_windows.dll",
          "$bundlePath/icudtl.dat",
          "$bundlePath/data/flutter_assets"
        )

        foreach ($file in $requiredFiles) {
          if (-not (Test-Path $file)) {
            Write-Error "Required file missing: $file"
            exit 1
          }
        }

        Write-Host "Creating ZIP from: $bundlePath"
        Compress-Archive -Path "$bundlePath\*" -DestinationPath $zipPath -CompressionLevel Optimal -Force

    - name: Upload Windows portable ZIP
      uses: actions/upload-artifact@v4
      with:
        name: teknetv-windows-portable
        path: teknetv-windows-portable.zip
        retention-days: 30
